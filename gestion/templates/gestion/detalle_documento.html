<!-- gestion/templates/gestion/detalle_documento.html (CORREGIDO) -->

{% extends 'gestion/base.html' %}

{% block title %}
    Detalle: {{ documento.expediente_id }}
{% endblock %}

{% block content %}

<!-- INICIO: Tarjeta de Detalles del Documento -->
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h4 mb-0">Detalle del Documento</h2>
            <p class="mb-0 text-primary fw-bold">{{ documento.expediente_id }}</p>
        </div>
        
        {% if documento.estado == 'recibido' %}
            <span class="badge bg-primary fs-6">{{ documento.get_estado_display }}</span>
        {% elif documento.estado == 'en_revision' %}
            <span class="badge bg-info text-dark fs-6">{{ documento.get_estado_display }}</span>
        {% elif documento.estado == 'derivado' %}
            <span class="badge bg-warning text-dark fs-6">{{ documento.get_estado_display }}</span>
        {% elif documento.estado == 'en_proceso' %}
            <span class="badge bg-warning text-dark fs-6">{{ documento.get_estado_display }}</span>
        {% elif documento.estado == 'atendido' %}
            <span class="badge bg-success fs-6">{{ documento.get_estado_display }}</span>
        {% elif documento.estado == 'archivado' %}
            <span class="badge bg-secondary fs-6">{{ documento.get_estado_display }}</span>
        {% else %}
            <span class="badge bg-dark fs-6">{{ documento.get_estado_display }}</span>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5 class="card-title">Asunto</h5>
                <p class="card-text">{{ documento.asunto }}</p>

                <h5 class="card-title mt-4">Remitente</h5>
                <p class="card-text">{{ documento.remitente }}</p>
                <!-- INICIO DEL NUEVO CÓDIGO -->
                {% if documento.archivo_adjunto %}
                <h5 class="card-title mt-4">Archivo Adjunto</h5>
                <p>
                    <a href="{{ documento.archivo_adjunto.url }}" class="btn btn-success" target="_blank">
                        Descargar Archivo
                    </a>
                    <span class="text-muted ms-2">{{ documento.archivo_adjunto.name|cut:"documentos/" }}</span>
                </p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h5 class="card-title">Tipo de Documento</h5>
                <p class="card-text">{{ documento.get_tipo_display }}</p>

                <h5 class="card-title mt-4">Fecha de Ingreso</h5>
                <p class="card-text">{{ documento.fecha_ingreso|date:"d/m/Y, h:i A" }}</p>

                <h5 class="card-title mt-4">Responsable Actual</h5>
                {% if documento.responsable_actual %}
                    <p class="card-text">
                        {# Muestra el nombre completo del usuario si existe, si no, el username #}
                        {{ documento.responsable_actual.usuario.get_full_name|default:documento.responsable_actual.usuario.username }}<br>
                        {# Y debajo, en texto más pequeño, su unidad #}
                        <small class="text-muted">{{ documento.responsable_actual.unidad_organizativa }}</small>
                    </p>
                {% else %}
                    <p class="card-text text-muted">No asignado</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-footer text-end">
        <a href="{% url 'lista_documentos' %}" class="btn btn-secondary">← Volver a la Bandeja</a>
        
        {% if documento.estado != 'archivado' and documento.estado != 'atendido' %}
            {% if user.perfilusuario == documento.responsable_actual %}
                <a href="{% url 'editar_documento' documento.expediente_id %}" class="btn btn-outline-secondary">Editar</a>
                <!-- BOTÓN PARA DERIVAR -->
                <a href="{% url 'derivar_documento' documento.expediente_id %}" class="btn btn-primary">Derivar</a>
                <!-- NUEVO BOTÓN PARA ATENDER -->
                <a href="{% url 'atender_documento' documento.expediente_id %}" class="btn btn-success">Atender y Finalizar</a>
            {% endif %}
            
            {% if user.perfilusuario.rol.nombre == "Mesa de Partes" %}
                <a href="{% url 'eliminar_documento' documento.expediente_id %}" class="btn btn-danger">Eliminar</a>
            {% endif %}
        {% else %}
            <span class="text-muted fst-italic">Este trámite ha sido finalizado.</span>
        {% endif %}
    </div>
</div>
<!-- FIN: Tarjeta de Detalles del Documento -->


<!-- INICIO: Tarjeta del Historial (Ahora está fuera, como un hermano del anterior) -->
<div class="card shadow-sm mt-4">
    <div class="card-header">
        <h3 class="h5 mb-0">Historial de Movimientos</h3>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            {% for movimiento in historial %}
                <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ movimiento.get_tipo_display }}</h6>
                        <small class="text-muted">{{ movimiento.fecha_movimiento|date:"d/m/Y, h:i A" }}</small>
                    </div>
                    <p class="mb-1">
                        {# Mostramos el origen del movimiento #}
                        {% if movimiento.usuario_origen %}
                            De: <strong>{{ movimiento.usuario_origen.unidad_organizativa }}</strong>
                            <small class="text-muted">({{ movimiento.usuario_origen.usuario.username }})</small>
                        {% else %}
                            De: <strong>Sistema</strong>
                        {% endif %}

                        {# --- INICIO DE LA CORRECCIÓN --- #}
                        {# Si hay un destino, lo mostramos #}
                        {% if movimiento.unidad_destino %}
                            &rarr;
                            Para: <strong>{{ movimiento.unidad_destino.unidad_organizativa }}</strong>
                            <small class="text-muted">({{ movimiento.unidad_destino.usuario.username }})</small>
                        
                        {# Si no hay destino (es una atención), mostramos un mensaje final #}
                        {% else %}
                            &rarr; <strong class="text-success">Trámite Finalizado</strong>
                        {% endif %}
                        {# --- FIN DE LA CORRECCIÓN --- #}
                    </p>
                    {% if movimiento.observaciones %}
                        <small class="text-muted">Observaciones: {{ movimiento.observaciones }}</small>
                    {% endif %}
                </li>
            {% empty %}
                <li class="list-group-item">No hay movimientos registrados para este documento.</li>
            {% endfor %}
        </ul>
    </div>
</div>
<!-- FIN: Tarjeta del Historial -->

{% endblock %}